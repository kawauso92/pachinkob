<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>PACHINKO BOARD</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#080c10;--surface:#0d1117;--surface2:#141b24;--surface3:#1c2530;
  --border:#1e2d3d;--accent:#00d4ff;--green:#39ff6e;--warn:#c8b400;
  --red:#ff4466;--text:#e2e8f0;--text2:#8899aa;--text3:#4a5a6a;
  --magenta:#ff6bff;--radius:12px;--radius-sm:8px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;max-width:430px;margin:0 auto;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
.app{position:relative;z-index:1;padding-bottom:80px;}
.header{padding:14px 16px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(8,12,16,0.95);backdrop-filter:blur(10px);position:sticky;top:0;z-index:100;}
.app-title{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;letter-spacing:3px;color:var(--accent);}
.header-sub{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.reload-btn{background:none;border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text2);font-size:11px;cursor:pointer;font-family:'JetBrains Mono',monospace;}
.reload-btn:active{border-color:var(--accent);color:var(--accent);}
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(8,12,16,0.97);border-top:1px solid var(--border);display:flex;backdrop-filter:blur(10px);z-index:100;}
.nav-btn{flex:1;padding:10px 4px 8px;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;border:none;background:none;color:var(--text3);font-size:10px;font-family:'Noto Sans JP',sans-serif;letter-spacing:1px;}
.nav-btn.active{color:var(--accent);}
.nav-btn .icon{font-size:20px;line-height:1;}
.tab-content{display:none;padding:12px 12px 0;}
.tab-content.active{display:block;}
.filter-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;margin-bottom:10px;}
.filter-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.filter-row:last-child{margin-bottom:0;}
.filter-label{font-size:9px;color:var(--text3);letter-spacing:1px;font-family:'JetBrains Mono',monospace;width:32px;flex-shrink:0;}
.filter-chips{display:flex;gap:6px;overflow-x:auto;flex:1;}
.filter-chips::-webkit-scrollbar{display:none;}
.chip{background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:4px 10px;font-size:10px;color:var(--text2);white-space:nowrap;cursor:pointer;font-family:'JetBrains Mono',monospace;letter-spacing:1px;transition:all 0.15s;}
.chip.active{background:rgba(0,212,255,0.1);border-color:var(--accent);color:var(--accent);}
.summary-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;margin-bottom:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}
.sb-item{text-align:center;}
.sb-label{font-size:9px;color:var(--text3);letter-spacing:1px;font-family:'JetBrains Mono',monospace;margin-bottom:2px;}
.sb-val{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;}
.sb-val.pos{color:var(--green);}
.sb-val.neg{color:var(--red);}
.record-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:11px 12px;margin-bottom:7px;position:relative;overflow:hidden;cursor:pointer;}
.record-card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--text3);}
.record-card.pos::before{background:var(--green);}
.record-card.neg::before{background:var(--red);}
.record-card:active{border-color:var(--accent);}
.rc-row1{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:5px;}
.rc-left1{flex:1;}
.rc-date{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text2);}
.rc-shop-dai{font-size:10px;color:var(--text3);margin-top:1px;}
.rc-kishu{font-size:13px;font-weight:500;margin-top:2px;}
.rc-right1{text-align:right;}
.rc-kosshi{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;line-height:1.2;}
.rc-kosshi.pos{color:var(--green);}
.rc-kosshi.neg{color:var(--red);}
.rc-jikan{font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;}
.rc-divider{height:1px;background:var(--border);margin:7px 0;}
.rc-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;}
.rc-stat{background:var(--surface2);border-radius:6px;padding:5px 6px;}
.rc-stat-label{font-size:8px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:2px;}
.rc-stat-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;}
.rc-stat-val.pos{color:var(--green);}
.rc-stat-val.neg{color:var(--red);}
.rc-stat-val.info{color:var(--accent);}
.rc-footer{display:flex;justify-content:space-between;align-items:center;margin-top:7px;}
.rc-uchi-badge{background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);color:var(--accent);font-size:9px;padding:2px 8px;border-radius:10px;font-family:'JetBrains Mono',monospace;}
.rc-uchi-badge.owner{background:rgba(57,255,110,0.08);border-color:rgba(57,255,110,0.2);color:var(--green);}
.load-more{width:100%;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:12px;font-family:'Rajdhani',sans-serif;letter-spacing:2px;cursor:pointer;margin-top:4px;}
.load-more:active{border-color:var(--accent);color:var(--accent);}
.detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:none;align-items:flex-start;}
.detail-overlay.show{display:flex;}
.detail-panel{background:var(--surface);border-bottom:1px solid var(--accent);border-radius:0 0 var(--radius) var(--radius);width:100%;max-width:430px;margin:0 auto;max-height:85vh;overflow-y:auto;padding:16px 14px 24px;}
.detail-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 14px;}
.detail-title{font-family:'Rajdhani',sans-serif;font-size:16px;letter-spacing:2px;color:var(--accent);margin-bottom:2px;}
.detail-sub{font-size:11px;color:var(--text2);margin-bottom:14px;line-height:1.6;}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px;}
.detail-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;}
.detail-label{font-size:9px;color:var(--text3);letter-spacing:1px;font-family:'JetBrains Mono',monospace;margin-bottom:3px;}
.detail-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;}
.detail-val.pos{color:var(--green);}
.detail-val.neg{color:var(--red);}
.detail-val.info{color:var(--accent);}
.delete-btn{width:100%;padding:13px;background:rgba(255,68,102,0.08);border:1px solid rgba(255,68,102,0.25);border-radius:var(--radius-sm);color:var(--red);font-size:13px;font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:2px;cursor:pointer;}
.delete-btn:active{background:rgba(255,68,102,0.2);}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:300;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;width:100%;max-width:320px;}
.modal-title{font-family:'Rajdhani',sans-serif;font-size:15px;letter-spacing:2px;margin-bottom:10px;}
.modal-msg{font-size:12px;color:var(--text2);margin-bottom:18px;line-height:1.8;white-space:pre-line;}
.modal-btns{display:flex;gap:8px;}
.modal-btn{flex:1;padding:11px;border-radius:var(--radius-sm);font-size:13px;font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1px;cursor:pointer;border:none;}
.modal-btn.ok{background:var(--red);color:#fff;}
.modal-btn.cancel{background:var(--surface2);color:var(--text2);}
.loading{text-align:center;padding:60px 20px;color:var(--text3);font-family:'Rajdhani',sans-serif;letter-spacing:3px;font-size:13px;}
.empty{text-align:center;padding:60px 20px;color:var(--text3);font-size:12px;}
.kg{color:#ff6bff;}.kb{color:var(--accent);}.ko{color:var(--green);}.kw{color:var(--warn);}.kn{color:var(--red);}.warn{color:var(--warn);}

/* è¨­å®šã‚¿ãƒ– */
.set-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px 10px;color:var(--text);font-size:13px;font-family:'Noto Sans JP',sans-serif;outline:none;}
.set-input:focus{border-color:var(--accent);}
.set-btn-save{flex:1;padding:11px;background:rgba(0,212,255,0.1);border:1px solid var(--accent);border-radius:var(--radius-sm);color:var(--accent);font-size:13px;font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1px;cursor:pointer;}
.set-btn-cancel{flex:1;padding:11px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:13px;font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1px;cursor:pointer;}
.set-btn-add{width:100%;padding:10px;background:none;border:1px dashed var(--border);border-radius:var(--radius-sm);color:var(--text3);font-size:12px;cursor:pointer;margin-top:4px;font-family:'JetBrains Mono',monospace;letter-spacing:1px;}
.set-btn-add:active{border-color:var(--accent);color:var(--accent);}
.set-row{display:flex;align-items:center;gap:8px;padding:9px 0;border-bottom:1px solid var(--border);}
.set-row:last-of-type{border-bottom:none;}
.set-row-name{flex:1;font-size:13px;}
.set-row-sub{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.set-row-actions{display:flex;gap:6px;flex-shrink:0;}
.set-icon-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;color:var(--text2);}
.set-icon-btn.edit:active{border-color:var(--accent);color:var(--accent);}
.set-icon-btn.del:active{border-color:var(--red);color:var(--red);}
.set-row.selected{background:rgba(0,212,255,0.05);border-radius:var(--radius-sm);padding:9px 6px;}

/* åˆ†æã‚¿ãƒ– */
.an-tabs{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;}
.an-tabs::-webkit-scrollbar{display:none;}
.an-tab{background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:5px 12px;font-size:10px;color:var(--text2);white-space:nowrap;cursor:pointer;font-family:'JetBrains Mono',monospace;letter-spacing:1px;}
.an-tab.active{background:rgba(0,212,255,0.1);border-color:var(--accent);color:var(--accent);}
.an-section{display:none;}
.an-section.active{display:block;}
.an-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-bottom:10px;}
.an-card-title{font-family:'Rajdhani',sans-serif;font-size:12px;letter-spacing:2px;color:var(--text2);margin-bottom:10px;}
.rank-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);}
.rank-row:last-child{border-bottom:none;}
.rank-num{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);width:18px;flex-shrink:0;}
.rank-name{flex:1;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.rank-sub{font-size:9px;color:var(--text3);margin-top:1px;font-family:'JetBrains Mono',monospace;}
.rank-val{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;text-align:right;flex-shrink:0;}
.rank-val.pos{color:var(--green);}
.rank-val.neg{color:var(--red);}
.rank-bar-wrap{width:100%;height:3px;background:var(--surface2);border-radius:2px;margin-top:4px;}
.rank-bar{height:3px;border-radius:2px;background:var(--accent);}
.rank-bar.neg{background:var(--red);}
canvas{display:block;width:100%;border-radius:var(--radius-sm);}
.un-dist{display:flex;align-items:flex-end;gap:3px;height:80px;margin-top:8px;}
.un-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;}
.un-bar{width:100%;border-radius:3px 3px 0 0;min-height:2px;}
.un-bar-label{font-size:8px;color:var(--text3);font-family:'JetBrains Mono',monospace;}
.an-period{display:flex;gap:6px;margin-bottom:10px;}
.an-period-btn{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:5px 10px;font-size:10px;color:var(--text2);cursor:pointer;font-family:'JetBrains Mono',monospace;}
.an-period-btn.active{border-color:var(--accent);color:var(--accent);}

/* ãƒ›ãƒ¼ãƒ ã‚¿ãƒ– */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.cal-title{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;letter-spacing:2px;color:var(--text);}
.cal-nav-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;color:var(--text2);font-size:14px;cursor:pointer;}
.cal-nav-btn:active{border-color:var(--accent);color:var(--accent);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-dow{text-align:center;font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace;padding:4px 0;letter-spacing:1px;}
.cal-dow.sun{color:#ff6b8a;}.cal-dow.sat{color:var(--accent);}
.cal-cell{min-height:48px;background:var(--surface2);border-radius:5px;padding:4px;display:flex;flex-direction:column;align-items:center;gap:1px;cursor:pointer;position:relative;}
.cal-cell.empty{background:none;cursor:default;}
.cal-cell.today{border:1px solid var(--accent);}
.cal-cell.has-rec:active{opacity:0.7;}
.cal-day{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;line-height:1;}
.cal-day.sun{color:#ff6b8a;}.cal-day.sat{color:var(--accent);}
.cal-val{font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;line-height:1.2;}
.cal-val.pos{color:var(--green);}.cal-val.neg{color:var(--red);}
.cal-dot{width:4px;height:4px;border-radius:50%;background:var(--text3);margin-top:1px;}
.home-summary{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.home-summary-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px;}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="app-title">PACHINKO BOARD</div>
      <div class="header-sub" id="header-sub">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <button class="reload-btn" onclick="loadRecords()">â†º æ›´æ–°</button>
  </div>

  <!-- ãƒ›ãƒ¼ãƒ ã‚¿ãƒ– -->
  <div class="tab-content active" id="tab-home">
    <div class="an-card">
      <div class="cal-header">
        <button class="cal-nav-btn" onclick="calPrev()">â€¹</button>
        <div class="cal-title" id="cal-title">â€”</div>
        <button class="cal-nav-btn" onclick="calNext()">â€º</button>
      </div>
      <div class="cal-grid">
        <div class="cal-dow sun">SUN</div>
        <div class="cal-dow">MON</div>
        <div class="cal-dow">TUE</div>
        <div class="cal-dow">WED</div>
        <div class="cal-dow">THU</div>
        <div class="cal-dow">FRI</div>
        <div class="cal-dow sat">SAT</div>
      </div>
      <div class="cal-grid" id="cal-body"></div>
    </div>
    <div class="an-card" id="home-summary"></div>
  </div>

  <div class="tab-content" id="tab-records">
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-label">æ‰“ã¡æ‰‹</div>
        <div class="filter-chips" id="uchi-filter"></div>
      </div>
      <div class="filter-row">
        <div class="filter-label">æœˆ</div>
        <div class="filter-chips" id="month-filter"></div>
      </div>
    </div>
    <div class="summary-bar">
      <div class="sb-item"><div class="sb-label">SESSIONS</div><div class="sb-val" id="sb-count">â€”</div></div>
      <div class="sb-item"><div class="sb-label">TOTAL</div><div class="sb-val" id="sb-total">â€”</div></div>
      <div class="sb-item"><div class="sb-label">WIN RATE</div><div class="sb-val" id="sb-winrate">â€”</div></div>
    </div>
    <div id="records-list"><div class="loading">LOADING...</div></div>
  </div>

  <div class="tab-content" id="tab-analysis">
    <div class="an-tabs">
      <div class="an-tab active" onclick="switchAnTab('monthly')">æœˆåˆ¥</div>
      <div class="an-tab" onclick="switchAnTab('kishu')">æ©Ÿç¨®åˆ¥</div>
      <div class="an-tab" onclick="switchAnTab('uchi')">æ‰“ã¡æ‰‹åˆ¥</div>
      <div class="an-tab" onclick="switchAnTab('overall')">ç·åˆ</div>
    </div>

    <!-- æœˆåˆ¥ -->
    <div class="an-section active" id="an-monthly">
      <div id="monthly-list"></div>
    </div>

    <!-- æ©Ÿç¨®åˆ¥ -->
    <div class="an-section" id="an-kishu">
      <div id="kishu-list"></div>
    </div>

    <!-- æ‰“ã¡æ‰‹åˆ¥ -->
    <div class="an-section" id="an-uchi">
      <div id="uchi-list"></div>
    </div>

    <!-- ç·åˆ -->
    <div class="an-section" id="an-overall">
      <div class="an-period">
        <button class="an-period-btn active" onclick="setRankPeriod('all',this)">å…¨æœŸé–“</button>
        <button class="an-period-btn" onclick="setRankPeriod('3m',this)">3ãƒ¶æœˆ</button>
        <button class="an-period-btn" onclick="setRankPeriod('1m',this)">å½“æœˆ</button>
      </div>
      <div class="an-card">
        <div class="an-card-title">æ©Ÿç¨®åˆ¥åæ”¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
        <div id="rank-kishu"></div>
      </div>
      <div class="an-card">
        <div class="an-card-title">åº—åˆ¥åæ”¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
        <div id="rank-shop"></div>
      </div>
      <div class="an-card">
        <div class="an-card-title">æ©Ÿç¨®åˆ¥ å¹³å‡æœŸå¾…æ™‚çµ¦</div>
        <div id="rank-kitai-kishu"></div>
      </div>
      <div class="an-card">
        <div class="an-card-title">åº—åˆ¥ å¹³å‡æœŸå¾…æ™‚çµ¦</div>
        <div id="rank-kitai-shop"></div>
      </div>
      <div class="an-card">
        <div class="an-card-title">é‹% åˆ†å¸ƒ</div>
        <div id="un-summary" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px;"></div>
        <div class="un-dist" id="un-dist"></div>
        <div style="display:flex;justify-content:space-between;margin-top:4px;">
          <span style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace;">0%</span>
          <span style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace;">100%</span>
          <span style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace;">200%+</span>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-content" id="tab-setting">
    <div class="an-tabs">
      <div class="an-tab active" onclick="switchSetTab('shop')">åº—</div>
      <div class="an-tab" onclick="switchSetTab('kishu')">æ©Ÿç¨®</div>
      <div class="an-tab" onclick="switchSetTab('uchi')">æ‰“ã¡æ‰‹</div>
    </div>

    <!-- åº—ãƒã‚¹ã‚¿ -->
    <div class="an-section active" id="set-shop">
      <div class="an-card" id="set-shop-form">
        <div class="an-card-title" id="set-shop-form-title">æ–°è¦è¿½åŠ </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
          <div>
            <div class="detail-label">åº—å</div>
            <input class="set-input" id="shop-name" type="text" placeholder="åº—å">
          </div>
          <div>
            <div class="detail-label">æ›é‡‘ç‡ï¼ˆç‰/100å††ï¼‰</div>
            <input class="set-input" id="shop-kokan" type="number" placeholder="28">
          </div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="set-btn-save" onclick="saveShop()">ä¿å­˜</button>
          <button class="set-btn-cancel" onclick="cancelSetEdit('shop')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
      <div class="an-card" id="set-shop-list"></div>
    </div>

    <!-- æ©Ÿç¨®ä¸€è¦§ -->
    <div class="an-section" id="set-kishu">
      <div class="an-card" id="set-kishu-form">
        <div class="an-card-title" id="set-kishu-form-title">æ–°è¦è¿½åŠ </div>
        <div style="margin-bottom:10px;">
          <div class="detail-label">æ©Ÿç¨®å</div>
          <input class="set-input" id="kishu-name" type="text" placeholder="æ©Ÿç¨®å" style="width:100%;">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px;">
          <div><div class="detail-label">å¹³å‡å‡ºç‰</div><input class="set-input" id="kishu-heikin" type="number" placeholder="0"></div>
          <div><div class="detail-label">ãƒˆãƒ¼ã‚¿ãƒ«</div><input class="set-input" id="kishu-total" type="number" placeholder="0"></div>
          <div><div class="detail-label">ãƒˆãƒ¼ã‚¿ãƒ«1R</div><input class="set-input" id="kishu-total1r" type="number" placeholder="0"></div>
          <div><div class="detail-label">æ™‚é–“åŠ¹ç‡</div><input class="set-input" id="kishu-jikan" type="number" placeholder="0"></div>
          <div><div class="detail-label">åˆå½“ãŸã‚Š</div><input class="set-input" id="kishu-hatsua" type="number" placeholder="0"></div>
          <div><div class="detail-label">å¹³å‡é€£</div><input class="set-input" id="kishu-heiren" type="number" placeholder="0"></div>
        </div>
        <div class="an-card-title" style="margin-bottom:6px;">ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¥å‡ºç‰</div>
        <div id="kishu-rounds-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;"></div>
        <div style="display:flex;gap:8px;">
          <button class="set-btn-save" onclick="saveKishu()">ä¿å­˜</button>
          <button class="set-btn-cancel" onclick="cancelSetEdit('kishu')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
      <div class="an-card" id="set-kishu-list"></div>
    </div>

    <!-- æ‰“ã¡æ‰‹ãƒã‚¹ã‚¿ -->
    <div class="an-section" id="set-uchi">
      <div class="an-card" id="set-uchi-form">
        <div class="an-card-title" id="set-uchi-form-title">æ–°è¦è¿½åŠ </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
          <div>
            <div class="detail-label">åå‰</div>
            <input class="set-input" id="uchi-name" type="text" placeholder="æ‰“ã¡æ‰‹å">
          </div>
          <div>
            <div class="detail-label">ã‚¿ã‚¤ãƒ—</div>
            <select class="set-input" id="uchi-type">
              <option value="è‡ªåˆ†">è‡ªåˆ†</option>
              <option value="ä»£æ‰“ã¡">ä»£æ‰“ã¡</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="set-btn-save" onclick="saveUchi()">ä¿å­˜</button>
          <button class="set-btn-cancel" onclick="cancelSetEdit('uchi')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
      <div class="an-card" id="set-uchi-list"></div>
    </div>
  </div>
</div>
<div class="bottom-nav">
  <button class="nav-btn active" id="nav-home"     onclick="switchTab('home')"><div class="icon">ğŸ </div><div>ãƒ›ãƒ¼ãƒ </div></button>
  <button class="nav-btn" id="nav-analysis" onclick="switchTab('analysis')"><div class="icon">ğŸ“Š</div><div>åˆ†æ</div></button>
  <button class="nav-btn" id="nav-records"  onclick="switchTab('records')"><div class="icon">ğŸ“‹</div><div>è¨˜éŒ²</div></button>
  <button class="nav-btn" id="nav-setting"  onclick="switchTab('setting')"><div class="icon">âš™ï¸</div><div>è¨­å®š</div></button>
</div>
<div class="detail-overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="detail-panel">
    <div class="detail-handle"></div>
    <div class="detail-title" id="detail-kishu">â€”</div>
    <div class="detail-sub" id="detail-sub">â€”</div>
    <div class="detail-grid" id="detail-grid"></div>
    <button class="delete-btn" id="delete-btn">ğŸ—‘ï¸ ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤</button>
  </div>
</div>
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-title">å‰Šé™¤ç¢ºèª</div>
    <div class="modal-msg" id="confirm-msg"></div>
    <div class="modal-btns">
      <button class="modal-btn cancel" id="confirm-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn ok" id="confirm-ok">å‰Šé™¤</button>
    </div>
  </div>
</div>
<script>
const GAS_URL  = 'https://script.google.com/macros/s/AKfycbzFtMJ354oeVAeNVTGLckNVXX9I1URLJTrlMTafDNO6UPOf7yo3bnaac_yPKYV8hVv8/exec';
const PAGE_SIZE = 30;
let ALL_RECORDS = [], filterUchi = 'all', filterMonth = currentMonth(), showCount = PAGE_SIZE, currentRecord = null;

function currentMonth() {
  const t = new Date();
  return t.getFullYear() + '-' + String(t.getMonth()+1).padStart(2,'0');
}

async function loadRecords() {
  document.getElementById('records-list').innerHTML = '<div class="loading">LOADING...</div>';
  document.getElementById('header-sub').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
  try {
    const res  = await fetch(GAS_URL + '?action=records&limit=200', {redirect:'follow'});
    const data = await res.json();
    if (data.success) { ALL_RECORDS = data.records; showCount = PAGE_SIZE; buildFilters(); render(); }
  } catch(e) {
    document.getElementById('records-list').innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—<br>æ›´æ–°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>';
    document.getElementById('header-sub').textContent = 'å–å¾—å¤±æ•—';
  }
}

const CACHE_KEY = 'pachinkob_cache_v1';

function saveCache(data) {
  try { localStorage.setItem(CACHE_KEY, JSON.stringify({ts: Date.now(), data})); } catch(e) {}
}
function loadCache() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return null;
    return JSON.parse(raw).data;
  } catch(e) { return null; }
}
function applyData(data) {
  MASTERS     = {shops: data.shops, kishus: data.kishus, uchis: data.uchis};
  ALL_RECORDS = data.records;
  showCount   = PAGE_SIZE;
  buildFilters();
  render();
  renderSetting();
  renderHome();
}

async function loadInit() {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å³åº§ã«è¡¨ç¤º
  const cache = loadCache();
  if (cache) {
    applyData(cache);
    document.getElementById('header-sub').textContent += ' ï¼ˆæ›´æ–°ä¸­...ï¼‰';
  } else {
    document.getElementById('records-list').innerHTML = '<div class="loading">LOADING...</div>';
    document.getElementById('header-sub').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
  }
  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§GASã‹ã‚‰æœ€æ–°å–å¾—
  try {
    const res  = await fetch(GAS_URL + '?action=init&limit=200', {redirect:'follow'});
    const data = await res.json();
    if (data.success) {
      saveCache(data);
      applyData(data);
    }
  } catch(e) {
    if (!cache) {
      document.getElementById('records-list').innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—<br>æ›´æ–°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>';
      document.getElementById('header-sub').textContent = 'å–å¾—å¤±æ•—';
    }
  }
}

function buildFilters() {
  const uchis  = ['all', ...new Set(ALL_RECORDS.map(r => r.uchi).filter(Boolean))];
  const months = ['all', ...new Set(ALL_RECORDS.map(r => r.date ? r.date.slice(0,7) : '').filter(Boolean))];
  const uBar = document.getElementById('uchi-filter');
  const mBar = document.getElementById('month-filter');
  uBar.innerHTML = '';
  mBar.innerHTML = '';
  uchis.forEach(u => {
    const c = makeChip(u === 'all' ? 'ALL' : u, u === filterUchi, () => { filterUchi = u; buildFilters(); showCount = PAGE_SIZE; render(); });
    uBar.appendChild(c);
  });
  months.forEach(m => {
    const c = makeChip(m === 'all' ? 'ALL' : m.replace('-','å¹´')+'æœˆ', m === filterMonth, () => { filterMonth = m; buildFilters(); showCount = PAGE_SIZE; render(); });
    c.dataset.val = m;
    mBar.appendChild(c);
  });
}

function makeChip(label, active, fn) {
  const c = document.createElement('div');
  c.className = 'chip' + (active ? ' active' : '');
  c.textContent = label;
  c.onclick = fn;
  return c;
}

function filtered() {
  return ALL_RECORDS.filter(r => {
    const uOk = filterUchi  === 'all' || r.uchi  === filterUchi;
    const mOk = filterMonth === 'all' || (r.date && r.date.startsWith(filterMonth));
    return uOk && mOk;
  });
}

function render() {
  const recs  = filtered();
  const total = recs.reduce((s, r) => s + (r.kosshi || 0), 0);
  const wins  = recs.filter(r => (r.kosshi || 0) > 0).length;
  const wr    = recs.length > 0 ? Math.round(wins / recs.length * 100) : 0;
  document.getElementById('sb-count').textContent = recs.length + 'ä»¶';
  const tel = document.getElementById('sb-total');
  tel.textContent = (total >= 0 ? '+' : '') + Math.round(total).toLocaleString('ja-JP');
  tel.className   = 'sb-val ' + (total >= 0 ? 'pos' : 'neg');
  document.getElementById('sb-winrate').textContent = wr + '%';
  document.getElementById('header-sub').textContent = 'å…¨' + ALL_RECORDS.length + 'ä»¶ / è¡¨ç¤º' + Math.min(showCount, recs.length) + 'ä»¶';

  const list = document.getElementById('records-list');
  if (recs.length === 0) { list.innerHTML = '<div class="empty">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  list.innerHTML = '';
  recs.slice(0, showCount).forEach(r => list.appendChild(makeCard(r)));
  if (recs.length > showCount) {
    const btn = document.createElement('button');
    btn.className   = 'load-more';
    btn.textContent = `â–¼ ã•ã‚‰ã«èª­ã¿è¾¼ã‚€ï¼ˆæ®‹ã‚Š${recs.length - showCount}ä»¶ï¼‰`;
    btn.onclick     = () => { showCount += PAGE_SIZE; render(); };
    list.appendChild(btn);
  }
}

function makeCard(r) {
  const pos  = (r.kosshi || 0) >= 0;
  const card = document.createElement('div');
  card.className = 'record-card ' + (pos ? 'pos' : 'neg');
  card.onclick   = () => openDetail(r);
  const isOwner = !r.uchi || r.uchi === 'è‡ªåˆ†';
  const stats = [
    {label:'æœŸå¾…æ™‚çµ¦', val: fmtKitai(r.kitaiJikyu), cls: kitaiCls(r.kitaiJikyu)},
    {label:'ä»•äº‹é‡',   val: fmtYen(r.shigoto),  cls: signCls(r.shigoto)},
    {label:'ç·å›è»¢',   val: r.soKaiten ? Math.round(r.soKaiten).toLocaleString('ja-JP')+'å›' : 'â€”', cls:'info'},
    {label:'å›è»¢ç‡',   val: r.kaitenRitsu ? r.kaitenRitsu+'å›/åƒå††' : 'â€”', cls:''},
    {label:'å·®ç‰',     val: r.sagitama != null ? (r.sagitama>=0?'+':'')+Math.round(r.sagitama).toLocaleString('ja-JP')+'ç‰' : 'â€”', cls: signCls(r.sagitama)},
    {label:'é‹(%)',    val: r.un != null ? Math.round(r.un)+'%' : 'â€”', cls: (r.un||0)>=100?'pos':(r.un||0)>=70?'':'neg'},
  ];
  card.innerHTML = `
    <div class="rc-row1">
      <div class="rc-left1">
        <div class="rc-date">${r.date||'â€”'}</div>
        <div class="rc-shop-dai">${r.shop||'â€”'}${r.daiban ? 'ã€€å°ï¼š'+r.daiban : ''}</div>
        <div class="rc-kishu">${r.kishu||'â€”'}</div>
      </div>
      <div class="rc-right1">
        <div class="rc-kosshi ${pos?'pos':'neg'}">${(r.kosshi>=0?'+':'')}${Math.round(r.kosshi||0).toLocaleString('ja-JP')}</div>
        <div class="rc-jikan">${r.jikan||'â€”'}</div>
      </div>
    </div>
    <div class="rc-divider"></div>
    <div class="rc-stats">${stats.map(s=>`<div class="rc-stat"><div class="rc-stat-label">${s.label}</div><div class="rc-stat-val ${s.cls}">${s.val}</div></div>`).join('')}</div>
    <div class="rc-footer">
      <span class="rc-uchi-badge ${isOwner?'owner':''}">${r.uchi||'è‡ªåˆ†'}</span>
      ${r.hoshu ? `<span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--green);">å ±é…¬ Â¥${Math.round(r.hoshu).toLocaleString('ja-JP')}</span>` : ''}
    </div>`;
  return card;
}

function openDetail(r) {
  currentRecord = r;
  document.getElementById('delete-btn').style.display = '';
  document.getElementById('detail-kishu').textContent = r.kishu || 'â€”';
  document.getElementById('detail-sub').textContent =
    [r.date, r.shop, r.daiban ? 'å°ï¼š'+r.daiban : '', r.uchi||'è‡ªåˆ†'].filter(Boolean).join('ã€€');
  const items = [
    {label:'åæ”¯',       val: fmtYen(r.kosshi),       cls: signCls(r.kosshi)},
    {label:'ç¨¼åƒæ™‚é–“',   val: r.jikan||'â€”',           cls:''},
    {label:'å·®ç‰',       val: r.sagitama!=null ? (r.sagitama>=0?'+':'')+Math.round(r.sagitama).toLocaleString('ja-JP')+'ç‰':'â€”', cls:signCls(r.sagitama)},
    {label:'æœŸå¾…æ™‚çµ¦',   val: fmtKitai(r.kitaiJikyu), cls: kitaiCls(r.kitaiJikyu)},
    {label:'ä»•äº‹é‡',     val: fmtYen(r.shigoto),      cls: signCls(r.shigoto)},
    {label:'ä»•äº‹é‡æ™‚çµ¦', val: fmtYen(r.shigotoJikyu), cls:''},
    {label:'ç·å›è»¢',     val: r.soKaiten ? Math.round(r.soKaiten).toLocaleString('ja-JP')+'å›':'â€”', cls:'info'},
    {label:'å›è»¢ç‡',     val: r.kaitenRitsu ? r.kaitenRitsu+'å›/åƒå††':'â€”', cls:'info'},
    {label:'ãƒœãƒ¼ãƒ€ãƒ¼',   val: r.border ? r.border+'å›/åƒå††':'â€”', cls:''},
    {label:'é‹(%)',      val: r.un!=null ? Math.round(r.un)+'%':'â€”', cls:(r.un||0)>=100?'pos':(r.un||0)>=70?'':'neg'},
    {label:'å ±é…¬',       val: r.hoshu ? 'Â¥'+Math.round(r.hoshu).toLocaleString('ja-JP'):'Â¥0', cls:'pos'},
  ];
  document.getElementById('detail-grid').innerHTML = items.map(i =>
    `<div class="detail-item"><div class="detail-label">${i.label}</div><div class="detail-val ${i.cls}">${i.val}</div></div>`
  ).join('');
  document.getElementById('detailOverlay').classList.add('show');
}

function closeDetail(e) {
  if (e && e.target !== document.getElementById('detailOverlay')) return;
  document.getElementById('detailOverlay').classList.remove('show');
  currentRecord = null;
}

document.getElementById('delete-btn').onclick = () => {
  if (!currentRecord) return;
  showConfirm(`${currentRecord.date}ã€€${currentRecord.kishu}\nåæ”¯ï¼š${fmtYen(currentRecord.kosshi)}\n\nã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
    try {
      await fetch(GAS_URL, {method:'POST',redirect:'follow',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'delete',row:currentRecord.row})});
    } catch(e) {}
    document.getElementById('detailOverlay').classList.remove('show');
    ALL_RECORDS = ALL_RECORDS.filter(r => r.row !== currentRecord.row);
    currentRecord = null;
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
    saveCache({shops: MASTERS.shops, kishus: MASTERS.kishus, uchis: MASTERS.uchis, records: ALL_RECORDS});
    buildFilters();
    render();
  });
};

function fmtYen(v) { if (v==null||v==='') return 'â€”'; return (v>=0?'+':'')+Math.round(v).toLocaleString('ja-JP')+'å††'; }
function fmtKitai(v) { if (v==null||v==='') return 'â€”'; return (v>=0?'+':'')+Math.round(v).toLocaleString('ja-JP')+'å††'; }
function signCls(v) { if (v==null||v==='') return ''; return v>=0?'pos':'neg'; }
function kitaiCls(v) { if (v==null||v==='') return ''; if(v>=3000)return 'kg'; if(v>=2500)return 'kb'; if(v>=2000)return 'ko'; if(v>=1500)return 'kw'; return 'kn'; }

let _cb = null;
let currentAnTab = 'monthly';
let rankPeriod = 'all';

// =============================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// =============================================
function switchTab(tab) {
  ['home','analysis','records','setting'].forEach(t => {
    document.getElementById('tab-'+t).classList.toggle('active', t === tab);
    document.getElementById('nav-'+t).classList.toggle('active', t === tab);
  });
  if (tab === 'analysis') renderAnalysis();
  if (tab === 'setting')  renderSetting();
  if (tab === 'home')     renderHome();
}

// =============================================
// ãƒ›ãƒ¼ãƒ ã‚¿ãƒ–
// =============================================
let calYear  = new Date().getFullYear();
let calMonth = new Date().getMonth(); // 0-indexed

function calPrev() { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderHome(); }
function calNext() { calMonth++; if (calMonth > 11) { calMonth = 0;  calYear++; } renderHome(); }

function renderHome() {
  renderCalendar();
  renderHomeSummary();
}

function renderCalendar() {
  const today = new Date();
  const firstDay = new Date(calYear, calMonth, 1).getDay(); // 0=Sun
  const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();

  document.getElementById('cal-title').textContent =
    calYear + 'å¹´' + (calMonth+1) + 'æœˆ';

  // å½“æœˆã®åæ”¯ã‚’dateã§ãƒãƒƒãƒ—
  const byDate = {};
  ALL_RECORDS.forEach(r => {
    if (!r.date) return;
    const d = new Date(r.date);
    if (d.getFullYear() !== calYear || d.getMonth() !== calMonth) return;
    const key = d.getDate();
    if (!byDate[key]) byDate[key] = {total:0, count:0};
    byDate[key].total += (r.kosshi||0);
    byDate[key].count++;
  });

  const cells = [];
  // ç©ºç™½ã‚»ãƒ«
  for (let i=0; i<firstDay; i++) cells.push('<div class="cal-cell empty"></div>');

  for (let d=1; d<=daysInMonth; d++) {
    const dow = (firstDay + d - 1) % 7;
    const isToday = today.getFullYear()===calYear && today.getMonth()===calMonth && today.getDate()===d;
    const rec = byDate[d];
    const dayClass = dow===0?'sun':dow===6?'sat':'';
    const dateStr = calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const clickAttr = rec ? `onclick="openCalDay('${dateStr}')"` : '';
    cells.push(`<div class="cal-cell${isToday?' today':''}${rec?' has-rec':''}" ${clickAttr}>
      <div class="cal-day ${dayClass}">${d}</div>
      ${rec ? `<div class="cal-val ${rec.total>=0?'pos':'neg'}">${fmtCalVal(rec.total)}</div>
               <div class="cal-dot" style="background:${rec.total>=0?'var(--green)':'var(--red)'}"></div>` : ''}
    </div>`);
  }

  document.getElementById('cal-body').innerHTML = cells.join('');
}

function fmtCalVal(v) {
  const abs = Math.abs(Math.round(v));
  if (abs >= 10000) return (v>=0?'+':'-') + (abs/1000).toFixed(0) + 'k';
  if (abs >= 1000)  return (v>=0?'+':'-') + (abs/1000).toFixed(1) + 'k';
  return (v>=0?'+':'') + Math.round(v);
}

function openCalDay(dateStr) {
  const recs = ALL_RECORDS.filter(r => r.date === dateStr);
  if (!recs.length) return;
  const total = recs.reduce((s,r) => s+(r.kosshi||0), 0);
  document.getElementById('detail-kishu').textContent = dateStr;
  document.getElementById('detail-sub').textContent   =
    recs.length + 'ä»¶ã€€åˆè¨ˆ ' + (total>=0?'+':'') + Math.round(total).toLocaleString('ja-JP') + 'å††';
  document.getElementById('detail-grid').innerHTML = recs.map(r => `
    <div style="padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer;" onclick="closeDetail();setTimeout(()=>openDetail(ALL_RECORDS.find(x=>x.row===${r.row})),150)">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:4px;">
        <div>
          <div style="font-size:13px;">${r.kishu||'â€”'}</div>
          <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;">${r.shop||'â€”'}ã€€${r.jikan||'â€”'}ã€€${r.uchi||'è‡ªåˆ†'}</div>
        </div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700;" class="${(r.kosshi||0)>=0?'pos':'neg'}">${((r.kosshi||0)>=0?'+':'')}${Math.round(r.kosshi||0).toLocaleString('ja-JP')}</div>
      </div>
      <div style="display:flex;gap:6px;">
        <div style="font-size:10px;color:var(--text3);">æœŸå¾…æ™‚çµ¦ <span class="${kitaiCls(r.kitaiJikyu)}" style="font-family:'JetBrains Mono',monospace;">${r.kitaiJikyu!=null?fmtKitai(r.kitaiJikyu):'â€”'}</span></div>
        <div style="font-size:10px;color:var(--text3);">ä»•äº‹é‡ <span class="${signCls(r.shigoto)}" style="font-family:'JetBrains Mono',monospace;">${r.shigoto!=null?fmtYen(r.shigoto):'â€”'}</span></div>
      </div>
    </div>`).join('');
  document.getElementById('delete-btn').style.display = 'none';
  currentRecord = null;
  document.getElementById('detailOverlay').classList.add('show');
}

function renderHomeSummary() {
  const el = document.getElementById('home-summary');
  // å¹´é›†è¨ˆ
  const recs = ALL_RECORDS.filter(r => {
    if (!r.date) return false;
    return new Date(r.date).getFullYear() === calYear;
  });

  if (!recs.length) {
    el.innerHTML = '<div class="empty" style="padding:16px">' + calYear + 'å¹´ã®è¨˜éŒ²ãªã—</div>';
    return;
  }

  const total    = recs.reduce((s,r) => s+(r.kosshi||0), 0);
  const wins     = recs.filter(r => (r.kosshi||0) > 0).length;
  const wr       = Math.round(wins/recs.length*100);
  const jikanMin = recs.reduce((s,r) => s+jikanToMin(r.jikan), 0);
  const jikyu    = jikanMin ? Math.round(total/(jikanMin/60)) : null;
  const shigoto  = recs.reduce((s,r) => s+(r.shigoto||0), 0);
  const days     = new Set(recs.map(r=>r.date)).size;
  let unW=0, unV=0;
  recs.forEach(r => { if(r.un!=null&&r.un!==''){const m=jikanToMin(r.jikan);unW+=m;unV+=r.un*m;} });
  const avgUn = unW ? Math.round(unV/unW) : null;

  el.innerHTML = `
    <div class="an-card-title">${calYear}å¹´ ã‚µãƒãƒªãƒ¼</div>
    <div class="home-summary">
      <div class="detail-item"><div class="detail-label">ç·åæ”¯</div><div class="detail-val ${signCls(total)}" style="font-size:20px;">${(total>=0?'+':'')}${Math.round(total).toLocaleString('ja-JP')}</div></div>
      <div class="detail-item"><div class="detail-label">å®Ÿæ™‚çµ¦</div><div class="detail-val ${signCls(jikyu)}" style="font-size:20px;">${jikyu!=null?fmtYen(jikyu):'â€”'}</div></div>
    </div>
    <div class="home-summary-3">
      <div class="detail-item"><div class="detail-label">ç¨¼åƒå›æ•°</div><div class="detail-val" style="font-size:14px;">${recs.length}å›</div></div>
      <div class="detail-item"><div class="detail-label">ç¨¼åƒæ—¥æ•°</div><div class="detail-val" style="font-size:14px;">${days}æ—¥</div></div>
      <div class="detail-item"><div class="detail-label">å‹ç‡</div><div class="detail-val ${wr>=50?'pos':'neg'}" style="font-size:14px;">${wr}%</div></div>
      <div class="detail-item"><div class="detail-label">ç¨¼åƒæ™‚é–“</div><div class="detail-val" style="font-size:14px;">${jikanMin?(jikanMin/60).toFixed(1)+'h':'â€”'}</div></div>
      <div class="detail-item"><div class="detail-label">ä»•äº‹é‡</div><div class="detail-val ${signCls(shigoto)}" style="font-size:14px;">${fmtYen(shigoto)}</div></div>
      <div class="detail-item"><div class="detail-label">å¹³å‡é‹%</div><div class="detail-val ${avgUn!=null?(avgUn>=100?'pos':avgUn>=70?'':'neg'):''}" style="font-size:14px;">${avgUn!=null?avgUn+'%':'â€”'}</div></div>
    </div>`;
}

function switchAnTab(tab) {
  currentAnTab = tab;
  const tabs = ['monthly','kishu','uchi','overall'];
  document.querySelectorAll('.an-tab').forEach((el,i) => el.classList.toggle('active', tabs[i] === tab));
  document.querySelectorAll('.an-section').forEach(el => el.classList.remove('active'));
  document.getElementById('an-'+tab).classList.add('active');
  renderAnalysis();
}

function setRankPeriod(p, btn) {
  rankPeriod = p;
  document.querySelectorAll('.an-period-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderOverall();
}

function renderAnalysis() {
  if (currentAnTab === 'monthly')  renderMonthly();
  if (currentAnTab === 'kishu')    renderKishu();
  if (currentAnTab === 'uchi')     renderUchi();
  if (currentAnTab === 'overall')  renderOverall();
}

// =============================================
// å…±é€šï¼šç¨¼åƒæ™‚é–“æ–‡å­—åˆ—â†’åˆ†ã«å¤‰æ›
// =============================================
function jikanToMin(str) {
  if (!str) return 0;
  const s = String(str).trim();
  if (s === 'â€”' || s === '-' || s === 'â€“' || s === '') return 0;
  const parts = s.split(':').map(Number);
  if (isNaN(parts[0])) return 0;
  return parts[0]*60 + (parts[1]||0);
}
function minToStr(m) {
  if (!m) return 'â€”';
  return Math.floor(m/60) + ':' + String(m%60).padStart(2,'0');
}

// =============================================
// å…±é€šï¼šé›†è¨ˆãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆ
// =============================================
function makeStatGrid(items) {
  return `<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">${
    items.map(i => `<div class="detail-item">
      <div class="detail-label">${i.label}</div>
      <div class="detail-val ${i.cls||''}" style="font-size:12px;">${i.val}</div>
      ${i.sub ? `<div style="font-size:9px;color:var(--text3);margin-top:2px;font-family:'JetBrains Mono',monospace;">${i.sub}</div>` : ''}
    </div>`).join('')
  }</div>`;
}

// =============================================
// æœˆåˆ¥
// =============================================
function renderMonthly() {
  const byMonth = {};
  ALL_RECORDS.forEach(r => {
    const m = r.date ? r.date.slice(0,7) : 'ä¸æ˜';
    if (!byMonth[m]) byMonth[m] = {total:0,shigoto:0,jikanMin:0,count:0,wins:0,kitaiW:0,kitaiV:0,unW:0,unV:0};
    const d = byMonth[m];
    const min = jikanToMin(r.jikan);
    d.total    += (r.kosshi||0);
    d.shigoto  += (r.shigoto||0);
    d.jikanMin += min;
    d.count++;
    if ((r.kosshi||0) > 0) d.wins++;
    if (r.kitaiJikyu != null && r.kitaiJikyu !== '') { d.kitaiW += min; d.kitaiV += r.kitaiJikyu * min; }
    if (r.un         != null && r.un         !== '') { d.unW    += min; d.unV    += r.un         * min; }
  });

  const months = Object.keys(byMonth).sort().reverse();
  const el = document.getElementById('monthly-list');
  if (!months.length) { el.innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }

  el.innerHTML = months.map(m => {
    const d    = byMonth[m];
    const pos  = d.total >= 0;
    const wr   = d.count ? Math.round(d.wins/d.count*100) : 0;
    const diff = d.total - d.shigoto;
    const jikanH = d.jikanMin ? (d.jikanMin/60).toFixed(1) : 'â€”';
    const jikyu  = d.jikanMin ? Math.round(d.total / (d.jikanMin/60)) : null;
    const avgKitai = d.kitaiW ? Math.round(d.kitaiV / d.kitaiW) : null;
    const avgUn    = d.unW    ? Math.round(d.unV    / d.unW)    : null;
    const items = [
      {label:'ç·åæ”¯',       val: fmtYen(d.total),    cls: signCls(d.total)},
      {label:'ä»•äº‹é‡åˆè¨ˆ',   val: fmtYen(d.shigoto),  cls: signCls(d.shigoto)},
      {label:'åæ”¯âˆ’ä»•äº‹é‡',  val: fmtYen(diff),       cls: signCls(diff), sub:'é‹ã®å½±éŸ¿é¡'},
      {label:'å®Ÿæ™‚çµ¦',       val: jikyu != null ? fmtYen(jikyu) : 'â€”', cls: signCls(jikyu)},
      {label:'ç¨¼åƒæ™‚é–“',     val: jikanH !== 'â€”' ? jikanH+'h' : 'â€”', cls:''},
      {label:'ç¨¼åƒå›æ•°',     val: d.count+'æˆ¦', cls:''},
      {label:'å‹ç‡',         val: wr+'%', cls: wr>=50?'pos':'neg'},
      {label:'å¹³å‡æœŸå¾…æ™‚çµ¦', val: avgKitai != null ? fmtYen(avgKitai) : 'â€”', cls: kitaiCls(avgKitai)},
      {label:'å¹³å‡é‹%',      val: avgUn != null ? avgUn+'%' : 'â€”', cls: avgUn!=null?(avgUn>=100?'pos':avgUn>=70?'':'neg'):''},
    ];
    return `<div class="an-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div class="an-card-title" style="margin-bottom:0;">${m.replace('-','å¹´')}æœˆ</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;" class="${pos?'pos':'neg'}">${(d.total>=0?'+':'')}${Math.round(d.total).toLocaleString('ja-JP')}</div>
      </div>
      ${makeStatGrid(items)}
    </div>`;
  }).join('');
}

// =============================================
// æ©Ÿç¨®åˆ¥
// =============================================
function renderKishu() {
  const map = {};
  ALL_RECORDS.forEach(r => {
    const k = r.kishu || 'ä¸æ˜';
    if (!map[k]) map[k] = {total:0,shigoto:0,jikanMin:0,count:0,wins:0,kitaiW:0,kitaiV:0,unW:0,unV:0,kaitenW:0,kaitenV:0};
    const d = map[k];
    const min = jikanToMin(r.jikan);
    d.total    += (r.kosshi||0);
    d.shigoto  += (r.shigoto||0);
    d.jikanMin += min;
    d.count++;
    if ((r.kosshi||0) > 0) d.wins++;
    if (r.kitaiJikyu  != null && r.kitaiJikyu  !== '') { d.kitaiW  += min; d.kitaiV  += r.kitaiJikyu  * min; }
    if (r.un          != null && r.un          !== '') { d.unW     += min; d.unV     += r.un          * min; }
    if (r.kaitenRitsu != null && r.kaitenRitsu !== '') { d.kaitenW += min; d.kaitenV += r.kaitenRitsu * min; }
  });

  const entries = Object.entries(map).sort((a,b) => b[1].count - a[1].count);
  const el = document.getElementById('kishu-list');
  if (!entries.length) { el.innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }

  el.innerHTML = entries.map(([name, d]) => {
    const pos  = d.total >= 0;
    const wr   = d.count ? Math.round(d.wins/d.count*100) : 0;
    const diff = d.total - d.shigoto;
    const jikyu    = d.jikanMin ? Math.round(d.total / (d.jikanMin/60)) : null;
    const avgKitai  = d.kitaiW  ? Math.round(d.kitaiV  / d.kitaiW)              : null;
    const avgUn     = d.unW     ? Math.round(d.unV     / d.unW)                 : null;
    const avgKaiten = d.kaitenW ? (d.kaitenV / d.kaitenW).toFixed(2)            : null;
    const items = [
      {label:'ç·åæ”¯',       val: fmtYen(d.total),    cls: signCls(d.total)},
      {label:'ä»•äº‹é‡åˆè¨ˆ',   val: fmtYen(d.shigoto),  cls: signCls(d.shigoto)},
      {label:'åæ”¯âˆ’ä»•äº‹é‡',  val: fmtYen(diff),       cls: signCls(diff)},
      {label:'å®Ÿæ™‚çµ¦',       val: jikyu != null ? fmtYen(jikyu) : 'â€”', cls: signCls(jikyu)},
      {label:'ç¨¼åƒå›æ•°',     val: d.count+'æˆ¦', cls:''},
      {label:'å‹ç‡',         val: wr+'%', cls: wr>=50?'pos':'neg'},
      {label:'å¹³å‡æœŸå¾…æ™‚çµ¦', val: avgKitai != null ? fmtYen(avgKitai) : 'â€”', cls: kitaiCls(avgKitai)},
      {label:'å¹³å‡å›è»¢ç‡',   val: avgKaiten ? avgKaiten+'å›/åƒå††' : 'â€”', cls:'info'},
      {label:'ç¨¼åƒæ™‚é–“è¨ˆ',   val: d.jikanMin ? (d.jikanMin/60).toFixed(1)+'h' : 'â€”', cls:''},
      {label:'å¹³å‡é‹%',      val: avgUn != null ? avgUn+'%' : 'â€”', cls: avgUn!=null?(avgUn>=100?'pos':avgUn>=70?'':'neg'):''},
    ];
    return `<div class="an-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div class="an-card-title" style="margin-bottom:0;">${name}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;" class="${pos?'pos':'neg'}">${(d.total>=0?'+':'')}${Math.round(d.total).toLocaleString('ja-JP')}</div>
      </div>
      ${makeStatGrid(items)}
    </div>`;
  }).join('');
}

// =============================================
// æ‰“ã¡æ‰‹åˆ¥
// =============================================
function renderUchi() {
  const map = {};
  ALL_RECORDS.forEach(r => {
    const k = r.uchi || 'è‡ªåˆ†';
    if (!map[k]) map[k] = {total:0,shigoto:0,hoshu:0,jikanMin:0,count:0,wins:0,kitaiW:0,kitaiV:0,unW:0,unV:0};
    const d = map[k];
    const min = jikanToMin(r.jikan);
    d.total    += (r.kosshi||0);
    d.shigoto  += (r.shigoto||0);
    d.hoshu    += (r.hoshu||0);
    d.jikanMin += min;
    d.count++;
    if ((r.kosshi||0) > 0) d.wins++;
    if (r.kitaiJikyu != null && r.kitaiJikyu !== '') { d.kitaiW += min; d.kitaiV += r.kitaiJikyu * min; }
    if (r.un         != null && r.un         !== '') { d.unW    += min; d.unV    += r.un         * min; }
  });

  const entries = Object.entries(map).sort((a,b) => b[1].count - a[1].count);
  const el = document.getElementById('uchi-list');
  if (!entries.length) { el.innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }

  el.innerHTML = entries.map(([name, d]) => {
    const isOwner = name === 'è‡ªåˆ†';
    const pos  = d.total >= 0;
    const wr   = d.count ? Math.round(d.wins/d.count*100) : 0;
    const torikomi = d.total - d.hoshu; // å–ã‚Šåˆ†
    const daROI  = d.hoshu ? Math.round((d.total - d.hoshu) / d.hoshu * 100) : null; // ä»£æ‰“ã¡ROI
    const shiROI = d.hoshu ? Math.round((d.shigoto - d.hoshu) / d.hoshu * 100) : null; // ä»•äº‹é‡ROI
    const hoshuRitsu = d.total > 0 ? Math.round(d.hoshu / d.total * 100) : null; // å ±é…¬Ã·åæ”¯
    const hoshuShigoto = d.shigoto > 0 ? Math.round(d.hoshu / d.shigoto * 100) : null; // å ±é…¬Ã·ä»•äº‹é‡
    const jikyu    = d.jikanMin ? Math.round(d.total / (d.jikanMin/60)) : null;
    const avgKitai = d.kitaiW   ? Math.round(d.kitaiV / d.kitaiW)       : null;
    const avgUn    = d.unW      ? Math.round(d.unV    / d.unW)          : null;

    const baseItems = [
      {label:'ç·åæ”¯',       val: fmtYen(d.total),   cls: signCls(d.total)},
      {label:'ä»•äº‹é‡åˆè¨ˆ',   val: fmtYen(d.shigoto), cls: signCls(d.shigoto)},
      {label:'ç¨¼åƒå›æ•°',     val: d.count+'æˆ¦',      cls:''},
      {label:'å‹ç‡',         val: wr+'%',            cls: wr>=50?'pos':'neg'},
      {label:'å®Ÿæ™‚çµ¦',       val: jikyu != null ? fmtYen(jikyu) : 'â€”', cls: signCls(jikyu)},
      {label:'å¹³å‡æœŸå¾…æ™‚çµ¦', val: avgKitai != null ? fmtYen(avgKitai) : 'â€”', cls: kitaiCls(avgKitai)},
      {label:'ç¨¼åƒæ™‚é–“è¨ˆ',   val: d.jikanMin ? (d.jikanMin/60).toFixed(1)+'h' : 'â€”', cls:''},
      {label:'å¹³å‡é‹%',      val: avgUn != null ? avgUn+'%' : 'â€”', cls: avgUn!=null?(avgUn>=100?'pos':avgUn>=70?'':'neg'):''},
    ];

    const dauchiItems = isOwner ? [] : [
      {label:'å ±é…¬åˆè¨ˆ',     val: d.hoshu ? 'Â¥'+Math.round(d.hoshu).toLocaleString('ja-JP') : 'Â¥0', cls:'warn'},
      {label:'å–ã‚Šåˆ†',       val: fmtYen(torikomi), cls: signCls(torikomi), sub:'åæ”¯âˆ’å ±é…¬'},
      {label:'ä»£æ‰“ã¡ROI',    val: daROI != null ? (daROI>=0?'+':'')+daROI+'%' : 'â€”', cls: daROI!=null?(daROI>=0?'pos':'neg'):'', sub:'(åæ”¯âˆ’å ±é…¬)Ã·å ±é…¬'},
      {label:'ä»•äº‹é‡ROI',    val: shiROI != null ? (shiROI>=0?'+':'')+shiROI+'%' : 'â€”', cls: shiROI!=null?(shiROI>=0?'pos':'neg'):'', sub:'(ä»•äº‹é‡âˆ’å ±é…¬)Ã·å ±é…¬'},
      {label:'å ±é…¬Ã·åæ”¯',    val: hoshuRitsu != null ? hoshuRitsu+'%' : 'â€”', cls:'', sub:'å‹ã¡åˆ†ã®ã†ã¡å ±é…¬å‰²åˆ'},
      {label:'å ±é…¬Ã·ä»•äº‹é‡',  val: hoshuShigoto != null ? hoshuShigoto+'%' : 'â€”', cls:'', sub:'æœŸå¾…å€¤ã«å¯¾ã™ã‚‹å ±é…¬ç‡'},
    ];

    return `<div class="an-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="an-card-title" style="margin-bottom:0;">${name}</div>
          <span class="rc-uchi-badge ${isOwner?'owner':''}">${isOwner?'OWNER':'ä»£æ‰“ã¡'}</span>
        </div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;" class="${pos?'pos':'neg'}">${(d.total>=0?'+':'')}${Math.round(d.total).toLocaleString('ja-JP')}</div>
      </div>
      ${makeStatGrid(baseItems)}
      ${dauchiItems.length ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">
        <div class="an-card-title" style="margin-bottom:8px;">ä»£æ‰“ã¡æŒ‡æ¨™</div>
        ${makeStatGrid(dauchiItems)}
      </div>` : ''}
    </div>`;
  }).join('');
}

// =============================================
// ç·åˆ
// =============================================
function getPeriodRecords() {
  const now = new Date();
  return ALL_RECORDS.filter(r => {
    if (rankPeriod === 'all') return true;
    if (!r.date) return false;
    const d = new Date(r.date);
    const diffM = (now.getFullYear()-d.getFullYear())*12+(now.getMonth()-d.getMonth());
    if (rankPeriod === '1m') return diffM === 0;
    if (rankPeriod === '3m') return diffM < 3;
    return true;
  });
}

function groupBy(recs, key) {
  const map = {};
  recs.forEach(r => {
    const k = r[key] || 'ä¸æ˜';
    if (!map[k]) map[k] = {total:0, count:0, wins:0, kitais:[]};
    map[k].total += (r.kosshi||0);
    map[k].count++;
    if ((r.kosshi||0) > 0) map[k].wins++;
    if (r.kitaiJikyu != null && r.kitaiJikyu !== '') map[k].kitais.push(r.kitaiJikyu);
  });
  return Object.entries(map).sort((a,b) => b[1].total - a[1].total);
}

function renderRankList(elId, entries) {
  const el = document.getElementById(elId);
  if (!entries.length) { el.innerHTML = '<div class="empty" style="padding:20px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
  const maxAbs = Math.max(...entries.map(e => Math.abs(e[1].total)), 1);
  el.innerHTML = entries.slice(0,8).map(([name, d], i) => {
    const pos = d.total >= 0;
    const barW = Math.round(Math.abs(d.total)/maxAbs*100);
    const wr = Math.round(d.wins/d.count*100);
    return `<div class="rank-row">
      <div class="rank-num">${i+1}</div>
      <div class="rank-name">
        <div>${name}</div>
        <div class="rank-sub">${d.count}æˆ¦ å‹ç‡${wr}%</div>
        <div class="rank-bar-wrap"><div class="rank-bar ${pos?'':'neg'}" style="width:${barW}%"></div></div>
      </div>
      <div class="rank-val ${pos?'pos':'neg'}">${(d.total>=0?'+':'')}${Math.round(d.total).toLocaleString('ja-JP')}</div>
    </div>`;
  }).join('');
}

function renderKitaiList(elId, entries) {
  const el = document.getElementById(elId);
  if (!entries.length) { el.innerHTML = '<div class="empty" style="padding:20px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
  const max = Math.max(...entries.map(e => Math.abs(e[1].avg)), 1);
  el.innerHTML = entries.slice(0,8).map(([name,d],i) => {
    const cls = kitaiCls(d.avg);
    const barW = Math.round(Math.abs(d.avg)/max*100);
    return `<div class="rank-row">
      <div class="rank-num">${i+1}</div>
      <div class="rank-name">
        <div>${name}</div>
        <div class="rank-sub">${d.count}ä»¶</div>
        <div class="rank-bar-wrap"><div class="rank-bar" style="width:${barW}%"></div></div>
      </div>
      <div class="rank-val ${cls}">${(d.avg>=0?'+':'')}${Math.round(d.avg).toLocaleString('ja-JP')}å††</div>
    </div>`;
  }).join('');
}

function renderOverall() {
  const recs = getPeriodRecords();
  renderRankList('rank-kishu', groupBy(recs, 'kishu'));
  renderRankList('rank-shop',  groupBy(recs, 'shop'));

  // æœŸå¾…æ™‚çµ¦ï¼ˆåŠ é‡å¹³å‡ï¼‰
  const byKishu = {}, byShop = {};
  recs.filter(r => r.kitaiJikyu != null && r.kitaiJikyu !== '').forEach(r => {
    const min = jikanToMin(r.jikan);
    [byKishu, byShop].forEach((map, i) => {
      const k = i===0 ? r.kishu : r.shop;
      if (!k) return;
      if (!map[k]) map[k] = {w:0, v:0, count:0};
      map[k].w += min; map[k].v += r.kitaiJikyu * min; map[k].count++;
    });
  });
  const toKitaiEntries = map => Object.entries(map)
    .map(([k,v]) => [k, {avg: v.w ? v.v/v.w : 0, count: v.count}])
    .sort((a,b) => b[1].avg - a[1].avg);
  renderKitaiList('rank-kitai-kishu', toKitaiEntries(byKishu));
  renderKitaiList('rank-kitai-shop',  toKitaiEntries(byShop));

  // é‹%åˆ†å¸ƒï¼ˆåŠ é‡å¹³å‡ï¼‰
  const unRecs = ALL_RECORDS.filter(r => r.un != null && r.un !== '');
  if (!unRecs.length) return;
  let unW = 0, unV = 0;
  unRecs.forEach(r => { const min = jikanToMin(r.jikan); unW += min; unV += r.un * min; });
  const avg = unW ? unV / unW : 0;
  const over100 = unRecs.filter(r=>r.un>=100).length;
  const under70 = unRecs.filter(r=>r.un<70).length;
  document.getElementById('un-summary').innerHTML = [
    {label:'å¹³å‡é‹%',   val: Math.round(avg)+'%', cls: avg>=100?'pos':avg>=70?'':'neg'},
    {label:'100%è¶…ãˆ',  val: over100+'ä»¶ ('+Math.round(over100/unRecs.length*100)+'%)', cls:'pos'},
    {label:'70%æœªæº€',   val: under70+'ä»¶ ('+Math.round(under70/unRecs.length*100)+'%)', cls:'neg'},
  ].map(i=>`<div class="detail-item"><div class="detail-label">${i.label}</div><div class="detail-val ${i.cls}" style="font-size:12px;">${i.val}</div></div>`).join('');
  const bins = Array(10).fill(0);
  unRecs.forEach(r => { bins[Math.min(9,Math.max(0,Math.floor(r.un/20)))]++; });
  const maxBin = Math.max(...bins, 1);
  const colors = ['#ff4466','#ff4466','#ff4466','#c8b400','#c8b400','#39ff6e','#00d4ff','#00d4ff','#ff6bff','#ff6bff'];
  document.getElementById('un-dist').innerHTML = bins.map((b,i) =>
    `<div class="un-bar-wrap"><div class="un-bar" style="height:${Math.round(b/maxBin*72)+2}px;background:${colors[i]};opacity:${b>0?1:0.2}"></div><div class="un-bar-label">${b}</div></div>`
  ).join('');
}
// =============================================
// è¨­å®šã‚¿ãƒ–
// =============================================
let MASTERS = {shops:[], kishus:[], uchis:[]};
let currentSetTab = 'shop';
let editingShopIdx  = null;
let editingKishuIdx = null;
let editingUchiIdx  = null;

async function loadMasters() {
  try {
    const res  = await fetch(GAS_URL + '?action=masters', {redirect:'follow'});
    const data = await res.json();
    if (data.success) MASTERS = data;
  } catch(e) {}
}

function switchSetTab(tab) {
  currentSetTab = tab;
  const tabs = ['shop','kishu','uchi'];
  document.querySelectorAll('#tab-setting .an-tab').forEach((el,i) => el.classList.toggle('active', tabs[i] === tab));
  document.querySelectorAll('#tab-setting .an-section').forEach(el => el.classList.remove('active'));
  document.getElementById('set-'+tab).classList.add('active');
  renderSetting();
}

function renderSetting() {
  renderShopList();
  renderKishuList();
  renderUchiList();
  buildRoundsGrid();
}

// ---------- åº— ----------
function renderShopList() {
  const el = document.getElementById('set-shop-list');
  if (!MASTERS.shops.length) { el.innerHTML = '<div class="empty" style="padding:16px">ãƒ‡ãƒ¼ã‚¿ãªã—</div><button class="set-btn-add" onclick="newShop()">ï¼‹ åº—ã‚’è¿½åŠ </button>'; return; }
  el.innerHTML = MASTERS.shops.map((s,i) => `
    <div class="set-row ${editingShopIdx===i?'selected':''}">
      <div class="set-row-name">
        <div>${s.name}</div>
        <div class="set-row-sub">æ›é‡‘ç‡ ${s.kokan}ç‰/100å††</div>
      </div>
      <div class="set-row-actions">
        <button class="set-icon-btn edit" onclick="editShop(${i})">ç·¨é›†</button>
        <button class="set-icon-btn del"  onclick="deleteShop(${i})">å‰Šé™¤</button>
      </div>
    </div>`).join('') + `<button class="set-btn-add" onclick="newShop()">ï¼‹ åº—ã‚’è¿½åŠ </button>`;
}

function newShop() {
  editingShopIdx = null;
  document.getElementById('set-shop-form-title').textContent = 'æ–°è¦è¿½åŠ ';
  document.getElementById('shop-name').value  = '';
  document.getElementById('shop-kokan').value = '';
  renderShopList();
}

function editShop(i) {
  editingShopIdx = i;
  const s = MASTERS.shops[i];
  document.getElementById('set-shop-form-title').textContent = 'ç·¨é›†ï¼š' + s.name;
  document.getElementById('shop-name').value  = s.name;
  document.getElementById('shop-kokan').value = s.kokan;
  renderShopList();
  document.getElementById('set-shop-form').scrollIntoView({behavior:'smooth'});
}

function deleteShop(i) {
  showConfirm(`ã€Œ${MASTERS.shops[i].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
    MASTERS.shops.splice(i,1);
    await saveMaster('shops', MASTERS.shops);
    renderShopList();
  });
}

async function saveShop() {
  const name  = document.getElementById('shop-name').value.trim();
  const kokan = parseFloat(document.getElementById('shop-kokan').value);
  if (!name) { alert('åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (editingShopIdx !== null) {
    MASTERS.shops[editingShopIdx] = {name, kokan};
  } else {
    MASTERS.shops.push({name, kokan});
  }
  await saveMaster('shops', MASTERS.shops);
  editingShopIdx = null;
  document.getElementById('shop-name').value  = '';
  document.getElementById('shop-kokan').value = '';
  document.getElementById('set-shop-form-title').textContent = 'æ–°è¦è¿½åŠ ';
  renderShopList();
}

function cancelSetEdit(type) {
  if (type==='shop')  { editingShopIdx  = null; document.getElementById('set-shop-form-title').textContent  = 'æ–°è¦è¿½åŠ '; document.getElementById('shop-name').value=''; document.getElementById('shop-kokan').value=''; }
  if (type==='kishu') { editingKishuIdx = null; document.getElementById('set-kishu-form-title').textContent = 'æ–°è¦è¿½åŠ '; clearKishuForm(); }
  if (type==='uchi')  { editingUchiIdx  = null; document.getElementById('set-uchi-form-title').textContent  = 'æ–°è¦è¿½åŠ '; document.getElementById('uchi-name').value=''; }
  renderShopList(); renderKishuList(); renderUchiList();
}

// ---------- æ©Ÿç¨® ----------
function buildRoundsGrid() {
  const el = document.getElementById('kishu-rounds-grid');
  if (!el) return;
  el.innerHTML = Array.from({length:10},(_,i) => `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;align-items:center;">
      <div><div class="detail-label">${i+1}R å‡ºç‰</div><input class="set-input" id="r-balls-${i}" type="number" placeholder="0"></div>
      <div><div class="detail-label">${i+1}R Ræ•°</div><input class="set-input" id="r-count-${i}" type="number" placeholder="0"></div>
    </div>`).join('');
}

function renderKishuList() {
  const el = document.getElementById('set-kishu-list');
  if (!MASTERS.kishus.length) { el.innerHTML = '<div class="empty" style="padding:16px">ãƒ‡ãƒ¼ã‚¿ãªã—</div><button class="set-btn-add" onclick="newKishu()">ï¼‹ æ©Ÿç¨®ã‚’è¿½åŠ </button>'; return; }
  el.innerHTML = MASTERS.kishus.map((k,i) => `
    <div class="set-row ${editingKishuIdx===i?'selected':''}">
      <div class="set-row-name">
        <div>${k.name}</div>
        <div class="set-row-sub">åˆå½“ 1/${k.hatsua} å¹³é€£ ${k.heiren} å¹³å‡å‡ºç‰ ${k.heikin}</div>
      </div>
      <div class="set-row-actions">
        <button class="set-icon-btn edit" onclick="editKishu(${i})">ç·¨é›†</button>
        <button class="set-icon-btn del"  onclick="deleteKishu(${i})">å‰Šé™¤</button>
      </div>
    </div>`).join('') + `<button class="set-btn-add" onclick="newKishu()">ï¼‹ æ©Ÿç¨®ã‚’è¿½åŠ </button>`;
}

function clearKishuForm() {
  ['kishu-name','kishu-heikin','kishu-total','kishu-total1r','kishu-jikan','kishu-hatsua','kishu-heiren'].forEach(id => {
    document.getElementById(id).value = '';
  });
  for (let i=0;i<10;i++) {
    const b = document.getElementById('r-balls-'+i);
    const c = document.getElementById('r-count-'+i);
    if(b) b.value=''; if(c) c.value='';
  }
}

function newKishu() {
  editingKishuIdx = null;
  document.getElementById('set-kishu-form-title').textContent = 'æ–°è¦è¿½åŠ ';
  clearKishuForm();
  renderKishuList();
}

function editKishu(i) {
  editingKishuIdx = i;
  const k = MASTERS.kishus[i];
  document.getElementById('set-kishu-form-title').textContent = 'ç·¨é›†ï¼š' + k.name;
  document.getElementById('kishu-name').value   = k.name;
  document.getElementById('kishu-heikin').value = k.heikin;
  document.getElementById('kishu-total').value  = k.total;
  document.getElementById('kishu-total1r').value= k.total1R;
  document.getElementById('kishu-jikan').value  = k.jikan;
  document.getElementById('kishu-hatsua').value = k.hatsua;
  document.getElementById('kishu-heiren').value = k.heiren;
  (k.rounds||[]).forEach((r,j) => {
    const b = document.getElementById('r-balls-'+j);
    const c = document.getElementById('r-count-'+j);
    if(b) b.value = r.balls||'';
    if(c) c.value = r.name ? parseInt(r.name) : '';
  });
  renderKishuList();
  document.getElementById('set-kishu-form').scrollIntoView({behavior:'smooth'});
}

function deleteKishu(i) {
  showConfirm(`ã€Œ${MASTERS.kishus[i].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
    MASTERS.kishus.splice(i,1);
    await saveMaster('kishus', MASTERS.kishus);
    renderKishuList();
  });
}

async function saveKishu() {
  const name = document.getElementById('kishu-name').value.trim();
  if (!name) { alert('æ©Ÿç¨®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const rounds = [];
  for(let i=0;i<10;i++) {
    const balls = parseFloat(document.getElementById('r-balls-'+i).value);
    const cnt   = parseFloat(document.getElementById('r-count-'+i).value);
    if (balls > 0 && cnt > 0) rounds.push({balls, name: cnt+'R'});
  }
  const obj = {
    name,
    heikin:  parseFloat(document.getElementById('kishu-heikin').value)||0,
    total:   parseFloat(document.getElementById('kishu-total').value)||0,
    total1R: parseFloat(document.getElementById('kishu-total1r').value)||0,
    jikan:   parseFloat(document.getElementById('kishu-jikan').value)||0,
    hatsua:  parseFloat(document.getElementById('kishu-hatsua').value)||0,
    heiren:  parseFloat(document.getElementById('kishu-heiren').value)||0,
    rounds,
  };
  if (editingKishuIdx !== null) MASTERS.kishus[editingKishuIdx] = obj;
  else MASTERS.kishus.push(obj);
  await saveMaster('kishus', MASTERS.kishus);
  editingKishuIdx = null;
  document.getElementById('set-kishu-form-title').textContent = 'æ–°è¦è¿½åŠ ';
  clearKishuForm();
  renderKishuList();
}

// ---------- æ‰“ã¡æ‰‹ ----------
function renderUchiList() {
  const el = document.getElementById('set-uchi-list');
  if (!MASTERS.uchis.length) { el.innerHTML = '<div class="empty" style="padding:16px">ãƒ‡ãƒ¼ã‚¿ãªã—</div><button class="set-btn-add" onclick="newUchi()">ï¼‹ æ‰“ã¡æ‰‹ã‚’è¿½åŠ </button>'; return; }
  el.innerHTML = MASTERS.uchis.map((u,i) => `
    <div class="set-row ${editingUchiIdx===i?'selected':''}">
      <div class="set-row-name">
        <div>${u.name}</div>
        <div class="set-row-sub">${u.type}</div>
      </div>
      <div class="set-row-actions">
        <button class="set-icon-btn edit" onclick="editUchi(${i})">ç·¨é›†</button>
        <button class="set-icon-btn del"  onclick="deleteUchi(${i})">å‰Šé™¤</button>
      </div>
    </div>`).join('') + `<button class="set-btn-add" onclick="newUchi()">ï¼‹ æ‰“ã¡æ‰‹ã‚’è¿½åŠ </button>`;
}

function newUchi() {
  editingUchiIdx = null;
  document.getElementById('set-uchi-form-title').textContent = 'æ–°è¦è¿½åŠ ';
  document.getElementById('uchi-name').value = '';
  renderUchiList();
}

function editUchi(i) {
  editingUchiIdx = i;
  const u = MASTERS.uchis[i];
  document.getElementById('set-uchi-form-title').textContent = 'ç·¨é›†ï¼š' + u.name;
  document.getElementById('uchi-name').value = u.name;
  document.getElementById('uchi-type').value = u.type;
  renderUchiList();
  document.getElementById('set-uchi-form').scrollIntoView({behavior:'smooth'});
}

function deleteUchi(i) {
  showConfirm(`ã€Œ${MASTERS.uchis[i].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
    MASTERS.uchis.splice(i,1);
    await saveMaster('uchis', MASTERS.uchis);
    renderUchiList();
  });
}

async function saveUchi() {
  const name = document.getElementById('uchi-name').value.trim();
  const type = document.getElementById('uchi-type').value;
  if (!name) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  // åå‰å¤‰æ›´ã®å ´åˆã€ç¨¼åƒè¨˜éŒ²ã‚‚é€£å‹•æ›´æ–°
  if (editingUchiIdx !== null) {
    const oldName = MASTERS.uchis[editingUchiIdx].name;
    if (oldName !== name) {
      // ALL_RECORDSã®ãƒ¡ãƒ¢ãƒªæ›´æ–°
      ALL_RECORDS.forEach(r => { if (r.uchi === oldName) r.uchi = name; });
      // GASã®ç¨¼åƒè¨˜éŒ²ã‚‚æ›´æ–°
      await fetch(GAS_URL, {
        method:'POST', redirect:'follow',
        headers:{'Content-Type':'text/plain'},
        body: JSON.stringify({action:'renameUchi', oldName, newName: name})
      }).catch(()=>{});
    }
    MASTERS.uchis[editingUchiIdx] = {name, type};
  } else {
    MASTERS.uchis.push({name, type});
  }
  await saveMaster('uchis', MASTERS.uchis);
  editingUchiIdx = null;
  document.getElementById('set-uchi-form-title').textContent = 'æ–°è¦è¿½åŠ ';
  document.getElementById('uchi-name').value = '';
  renderUchiList();
}

// ---------- GASä¿å­˜ ----------
async function saveMaster(key, data) {
  try {
    await fetch(GAS_URL, {
      method:'POST', redirect:'follow',
      headers:{'Content-Type':'text/plain'},
      body: JSON.stringify({action:'saveMaster', key, data})
    });
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
    saveCache({shops: MASTERS.shops, kishus: MASTERS.kishus, uchis: MASTERS.uchis, records: ALL_RECORDS});
  } catch(e) {}
}

// åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒã‚¹ã‚¿å–å¾—
window.addEventListener('DOMContentLoaded', async () => {
  await loadInit();
});

function showConfirm(msg, cb) {
  document.getElementById('confirm-msg').textContent = msg;
  _cb = cb;
  document.getElementById('confirmModal').classList.add('show');
}
document.getElementById('confirm-ok').onclick = () => { document.getElementById('confirmModal').classList.remove('show'); if(_cb)_cb(); _cb=null; };
document.getElementById('confirm-cancel').onclick = () => { document.getElementById('confirmModal').classList.remove('show'); _cb=null; };
</script>
</body>
</html>
